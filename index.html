<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>B√§nkskivor ‚Äì L√§genhetsstatus</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; padding:20px; }
table { border-collapse: collapse; width:100%; margin-bottom:20px;}
th, td { border:1px solid #999; padding:6px; text-align:center; }
th { background:#eee; }

.red { background:#f8b4b4; }
.yellow { background:#fff3b0; }
.green { background:#b7f7b7; }

.locked { background:#ddd; }

button, select, input { padding:6px 10px; font-size:14px; margin-right:10px; }
.summary td { font-weight:bold; }
</style>
</head>
<body>

<h2>Status b√§nkskivor ‚Äì badrum & k√∂k</h2>

<label>Ditt namn:
<input type="text" id="userName" placeholder="Skriv ditt namn"></label>

<button onclick="toggleAdmin()">üîê Admin toggle</button>

<br><br>

<table id="table"></table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDIqP7MziTwxOS58JOs2ElYnHVKY9P1h8Y",
  authDomain: "bankskivor-status.firebaseapp.com",
  projectId: "bankskivor-status",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const ADMINS = ["admin","adrian"];
let adminLocked = true;

const apartments = [
{house:"516",floor:5,apt:"1001"},
{house:"516",floor:6,apt:"1101"}
];

const table = document.getElementById("table");
table.innerHTML = `
<tr>
<th>Hus</th><th>Plan</th><th>Lgh</th>
<th>Montage badrum klart</th>
<th>Montage k√∂k klart</th>
<th>Badrum m√•ttad</th>
<th>Badrum monterad</th>
<th>K√∂k m√•ttad</th>
<th>K√∂k monterad</th>
<th>Status</th>
<th>Kommentar</th>
<th>Kommentar av</th>
<th>Senast √§ndrad</th>
<th>Av</th>
</tr>`;

apartments.forEach((row,i)=>{
 let tr = document.createElement("tr");
 tr.innerHTML = `
<td>${row.house}</td>
<td>Plan ${row.floor}</td>
<td>${row.apt}</td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td class="status"></td>
<td><input type="text" class="comment"></td>
<td class="commentUser"></td>
<td class="time"></td>
<td class="user"></td>`;
 table.appendChild(tr);

 tr.querySelectorAll("input").forEach(inp=>{
  inp.addEventListener("change",()=>saveRow(i,tr));
 });
});

function isAdmin(){
 let name = document.getElementById("userName").value.toLowerCase();
 return ADMINS.includes(name);
}

function toggleAdmin(){
 if(!isAdmin()){
   alert("Endast admin/adrian kan l√•sa upp.");
   return;
 }
 adminLocked = !adminLocked;
 updateAllRows();
}

function saveRow(i,tr){
 if(adminLocked && !isAdmin()) return;

 let name = document.getElementById("userName").value || "Ok√§nd";
 let time = new Date().toLocaleString();
 let inputs = tr.querySelectorAll("input");

 let data = {
  mBath:inputs[0].checked,
  mKitchen:inputs[1].checked,
  bm:inputs[2].checked,
  bmon:inputs[3].checked,
  km:inputs[4].checked,
  kmon:inputs[5].checked,
  comment: tr.querySelector(".comment").value,
  commentUser: name,
  time: time,
  user: name
 };

 db.collection("rows").doc("row"+i).set(data);
}

db.collection("rows").onSnapshot(snapshot=>{
 snapshot.forEach(doc=>{
  let i = parseInt(doc.id.replace("row",""));
  let tr = table.rows[i+1];
  if(!tr) return;
  let d = doc.data();
  let inputs = tr.querySelectorAll("input");

  inputs[0].checked = d.mBath;
  inputs[1].checked = d.mKitchen;
  inputs[2].checked = d.bm;
  inputs[3].checked = d.bmon;
  inputs[4].checked = d.km;
  inputs[5].checked = d.kmon;

  tr.querySelector(".comment").value = d.comment || "";
  tr.querySelector(".commentUser").textContent = d.commentUser || "";
  tr.querySelector(".time").textContent = d.time;
  tr.querySelector(".user").textContent = d.user;

  updateRow(tr);
 });
});

function updateRow(tr){
 let inputs = tr.querySelectorAll("input");
 let statusCell = tr.querySelector(".status");

 let allChecked = true;
 inputs.forEach(inp=>{
   if(!inp.checked) allChecked = false;
 });

 tr.classList.remove("red","yellow","green","locked");

 if(adminLocked && !isAdmin()){
   tr.classList.add("locked");
   statusCell.textContent = "L√•st av Admin";
 } else if(allChecked){
   tr.classList.add("green");
   statusCell.textContent = "Klar";
 } else {
   tr.classList.add("yellow");
   statusCell.textContent = "P√•g√•r";
 }

 let allow = (!adminLocked || isAdmin());
 inputs.forEach(inp=> inp.disabled = !allow);
 tr.querySelector(".comment").disabled = !allow;
}

function updateAllRows(){
 Array.from(table.rows).forEach((row,i)=>{
   if(i===0) return;
   updateRow(row);
 });
}
</script>

</body>
</html>
