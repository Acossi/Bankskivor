<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="UTF-8">
<title>BÃ¤nkskivor â€“ LÃ¤genhetsstatus</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial, sans-serif; padding:20px; }
table { border-collapse: collapse; width:100%; margin-bottom:20px;}
th, td { border:1px solid #999; padding:6px; text-align:center; }
th { background:#eee; }

.red { background:#f8b4b4; }
.yellow { background:#fff3b0; }
.green { background:#b7f7b7; }

button, select, input { padding:6px 10px; font-size:14px; margin-right:10px; }
.summary td { font-weight:bold; }

.comment { width:100%; }
</style>
</head>
<body>

<h2>Status bÃ¤nkskivor â€“ badrum & kÃ¶k (per lÃ¤genhet)</h2>

<label>Ditt namn:
<input type="text" id="userName" placeholder="Skriv ditt namn"></label>

<br><br>

<select id="houseFilter" onchange="applyFilters()">
<option value="all">Visa alla hus</option>
<option value="516">516</option>
<option value="515">515</option>
<option value="514">514</option>
<option value="513">513</option>
</select>

<input type="text" id="aptSearch" placeholder="SÃ¶k lÃ¤genhetsnr" onkeyup="applyFilters()">

<button onclick="exportToExcel()">ðŸ“¤ Exportera till Excel</button>

<table id="table"></table>

<h3>SammanstÃ¤llning per hus</h3>
<table id="summary"></table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyDIqP7MziTwxOS58JOs2ElYnHVKY9P1h8Y",
  authDomain: "bankskivor-status.firebaseapp.com",
  projectId: "bankskivor-status",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

const apartments = [
{house:"516",floor:5,apt:"1001"},
{house:"516",floor:6,apt:"1101"},{house:"516",floor:6,apt:"1102"},{house:"516",floor:6,apt:"1103"},{house:"516",floor:6,apt:"1104"},
{house:"516",floor:7,apt:"1201"},{house:"516",floor:7,apt:"1202"},{house:"516",floor:7,apt:"1203"},{house:"516",floor:7,apt:"1204"},
{house:"516",floor:8,apt:"1301"},{house:"516",floor:8,apt:"1302"},{house:"516",floor:8,apt:"1303"},{house:"516",floor:8,apt:"1304"},
{house:"516",floor:9,apt:"1401"},{house:"516",floor:9,apt:"1402"},{house:"516",floor:9,apt:"1403"},{house:"516",floor:9,apt:"1404"},
{house:"516",floor:10,apt:"1501"},{house:"516",floor:10,apt:"1502"},{house:"516",floor:10,apt:"1503"},{house:"516",floor:10,apt:"1504"},
{house:"516",floor:11,apt:"1601"},{house:"516",floor:11,apt:"1602"},{house:"516",floor:11,apt:"1603"},
{house:"516",floor:12,apt:"1701"},{house:"516",floor:12,apt:"1702"},{house:"516",floor:12,apt:"1703"},

{house:"515",floor:5,apt:"1001"},{house:"515",floor:5,apt:"1002"},
{house:"515",floor:6,apt:"1101"},{house:"515",floor:6,apt:"1102"},{house:"515",floor:6,apt:"1103"},{house:"515",floor:6,apt:"1104"},{house:"515",floor:6,apt:"1105"},{house:"515",floor:6,apt:"1106"},
{house:"515",floor:7,apt:"1201"},{house:"515",floor:7,apt:"1202"},{house:"515",floor:7,apt:"1203"},{house:"515",floor:7,apt:"1204"},{house:"515",floor:7,apt:"1205"},{house:"515",floor:7,apt:"1206"},
{house:"515",floor:8,apt:"1301"},{house:"515",floor:8,apt:"1302"},{house:"515",floor:8,apt:"1303"},{house:"515",floor:8,apt:"1304"},{house:"515",floor:8,apt:"1305"},{house:"515",floor:8,apt:"1306"},
{house:"515",floor:9,apt:"1401"},{house:"515",floor:9,apt:"1402"},{house:"515",floor:9,apt:"1403"},{house:"515",floor:9,apt:"1404"},{house:"515",floor:9,apt:"1405"},{house:"515",floor:9,apt:"1406"},
{house:"515",floor:10,apt:"1501"},{house:"515",floor:10,apt:"1502"},{house:"515",floor:10,apt:"1503"},{house:"515",floor:10,apt:"1504"},{house:"515",floor:10,apt:"1505"},{house:"515",floor:10,apt:"1506"},

{house:"514",floor:5,apt:"1001"},{house:"514",floor:5,apt:"1002"},{house:"514",floor:5,apt:"1003"},{house:"514",floor:5,apt:"1004"},{house:"514",floor:5,apt:"1005"},
{house:"514",floor:6,apt:"1101"},{house:"514",floor:6,apt:"1102"},{house:"514",floor:6,apt:"1103"},
{house:"514",floor:7,apt:"1201"},{house:"514",floor:7,apt:"1202"},{house:"514",floor:7,apt:"1203"},{house:"514",floor:7,apt:"1204"},
{house:"514",floor:8,apt:"1301"},{house:"514",floor:8,apt:"1302"},{house:"514",floor:8,apt:"1303"},{house:"514",floor:8,apt:"1304"},
{house:"514",floor:9,apt:"1401"},{house:"514",floor:9,apt:"1402"},{house:"514",floor:9,apt:"1403"},{house:"514",floor:9,apt:"1404"},
{house:"514",floor:10,apt:"1501"},{house:"514",floor:10,apt:"1502"},{house:"514",floor:10,apt:"1503"},{house:"514",floor:10,apt:"1504"},
{house:"514",floor:11,apt:"1601"},

{house:"513",floor:5,apt:"1001"},{house:"513",floor:5,apt:"1002"},
{house:"513",floor:6,apt:"1101"},{house:"513",floor:6,apt:"1102"},
{house:"513",floor:7,apt:"1201"},{house:"513",floor:7,apt:"1202"},{house:"513",floor:7,apt:"1203"},{house:"513",floor:7,apt:"1204"},
{house:"513",floor:8,apt:"1301"},{house:"513",floor:8,apt:"1302"},{house:"513",floor:8,apt:"1303"},{house:"513",floor:8,apt:"1304"},
{house:"513",floor:9,apt:"1401"},{house:"513",floor:9,apt:"1402"},{house:"513",floor:9,apt:"1403"},{house:"513",floor:9,apt:"1404"},
{house:"513",floor:10,apt:"1501"},{house:"513",floor:10,apt:"1502"},
];

const table = document.getElementById("table");
table.innerHTML = `
<tr>
<th>Hus</th><th>Plan</th><th>Lgh</th>
<th>Badrum MÃ¥ttad</th><th>Badrum Monterad</th>
<th>KÃ¶k MÃ¥ttad</th><th>KÃ¶k Monterad</th>
<th>Status</th><th>Kommentar</th><th>Kommentar av</th><th>Senast Ã¤ndrad</th><th>Av</th>
</tr>`;

apartments.forEach((row,i)=>{
 let tr = document.createElement("tr");
 tr.dataset.house = row.house;
 tr.dataset.apt = row.apt;
 tr.innerHTML = `
<td>${row.house}</td>
<td>Plan ${row.floor}</td>
<td>${row.apt}</td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td><input type="checkbox"></td>
<td class="status"></td>
<td><input type="text" class="comment" placeholder="Skriv kommentar"></td>
<td class="commentUser"></td>
<td class="time"></td>
<td class="user"></td>`;
 table.appendChild(tr);

 tr.querySelectorAll("input").forEach(inp=>{
  inp.addEventListener("change",()=>saveRow(i,tr));
 });
});

function saveRow(i,tr){
 let name = document.getElementById("userName").value || "OkÃ¤nd";
 let time = new Date().toLocaleString();
 let inputs = tr.querySelectorAll("input");
 let comment = tr.querySelector(".comment").value;

 let data = {
  bm:inputs[0].checked,
  bmon:inputs[1].checked,
  km:inputs[2].checked,
  kmon:inputs[3].checked,
  comment: comment,
  commentUser: name,
  time: time,
  user: name
 };

 db.collection("rows").doc("row"+i).set(data);
}

db.collection("rows").onSnapshot(snapshot=>{
 snapshot.forEach(doc=>{
  let i = parseInt(doc.id.replace("row",""));
  let tr = table.rows[i+1];
  if(!tr) return;
  let saved = doc.data();
  let inputs = tr.querySelectorAll("input");

  inputs[0].checked = saved.bm;
  inputs[1].checked = saved.bmon;
  inputs[2].checked = saved.km;
  inputs[3].checked = saved.kmon;
  tr.querySelector(".comment").value = saved.comment || "";
  tr.querySelector(".commentUser").textContent = saved.commentUser || "";
  tr.querySelector(".time").textContent = saved.time;
  tr.querySelector(".user").textContent = saved.user;
  updateRow(tr);
 });
 updateSummary();
});

function updateRow(tr){
 let inputs = tr.querySelectorAll("input");
 let statusCell = tr.querySelector(".status");
 let done = inputs[1].checked && inputs[3].checked;
 let started = inputs[0].checked || inputs[1].checked || inputs[2].checked || inputs[3].checked;

 tr.classList.remove("red","yellow","green");

 if(done){
   tr.classList.add("green");
   statusCell.textContent="Klar";
 } else if(started){
   tr.classList.add("yellow");
   statusCell.textContent="PÃ¥gÃ¥r";
 } else {
   tr.classList.add("red");
   statusCell.textContent="Ej startad";
 }
}

function applyFilters(){
 let house = document.getElementById("houseFilter").value;
 let aptSearch = document.getElementById("aptSearch").value.toLowerCase();

 Array.from(table.rows).forEach((row,i)=>{
  if(i===0) return;
  let matchHouse = (house==="all" || row.dataset.house===house);
  let matchApt = row.dataset.apt.toLowerCase().includes(aptSearch);
  row.style.display = (matchHouse && matchApt) ? "" : "none";
 });
}

function updateSummary(){
 let count = {};
 apartments.forEach((f,i)=>{
  let row = table.rows[i+1];
  let status = row.classList.contains("green")?"green":
               row.classList.contains("yellow")?"yellow":"red";
  if(!count[f.house]) count[f.house]={red:0,yellow:0,green:0};
  count[f.house][status]++;
 });

 let sTable = document.getElementById("summary");
 sTable.innerHTML = `
<tr>
<th>Hus</th><th>ðŸ”´ Ej pÃ¥bÃ¶rjad</th><th>ðŸŸ¡ Delvis klar</th><th>ðŸŸ¢ Klar</th>
</tr>`;
 for(let h in count){
  sTable.innerHTML += `
  <tr class="summary">
   <td>${h}</td>
   <td>${count[h].red}</td>
   <td>${count[h].yellow}</td>
   <td>${count[h].green}</td>
  </tr>`;
 }
}

function exportToExcel(){
 let html = "<table border='1'>";
 html += table.innerHTML;
 html += "</table>";
 let blob = new Blob([html],{type:"application/vnd.ms-excel"});
 let link = document.createElement("a");
 link.href = URL.createObjectURL(blob);
 link.download = "bankskivor_lagenheter.xls";
 link.click();
}
</script>

</body>
</html>
